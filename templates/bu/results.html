{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}" media="all">
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='resultsStyle.css')}}" media="all">
<link href="https://fonts.googleapis.com/css?family=Questrial&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}



{% block header %}
  {{super()}}
{% endblock %}



{% block content %}
<section>
    <center>
        <h1>Results</h1>
        <div id="visualisation" class="contentBody">
          <h2>V I E W</h2>
          <div id="viewport"></div>
	  <a href="/voronoia/downloads/{{user}}/{{job}}/results.zip"><i>file_download</i></a>
        </div>
    </center>
</section>
{% endblock %}



{% block scripts %}
<script src="{{url_for('static', filename='ngl.js')}}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<!-- UI -->
<script src="{{url_for('static',filename='ngl/js/lib/signals.min.js')}}"></script>
<script src="{{url_for('static',filename='ngl/js/lib/tether.min.js')}}"></script>
<script src="{{url_for('static',filename='ngl/js/lib/colorpicker.min.js')}}"></script>
<script src="{{url_for('static',filename='ngl/js/lib/ui/ui.js')}}"></script>
<script src="{{url_for('static',filename='ngl/js/lib/ui/ui.extra.js')}}"></script>
<!--<script src="{{url_for('static',filename='ngl/js/lib/ui/ui.ngl.js')}}"></script>-->
<script src="{{url_for('static',filename='ui.ngl.js')}}"></script>
<!--<script src="{{url_for('static',filename='ngl/js/ngl/gui.js')}}"></script>-->
<script src="{{url_for('static',filename='gui.js')}}"></script>



<script> 
    NGL.mainScriptPathFile = "{{url_for('static', filename='ngl.js')}}";

    $().ready( function() {
        //div = $('<div class="btn"><div></div><div></div><div></div><div></div></div>'); //$('#progress').append(div); //status_url = getModelURL('/status/{{user}}/{{job}}');
   	//update_progress( status_url, div[0] );
	visualize();
    });

    
    function getModelURL(model) {
   	var href = window.location.href;
  	var command = href.substr(0, href.lastIndexOf("/")) + model;
        return command;
    }


    function loadPDB(stage, filename, name, representations, representation_dicts, center) {
	file = getModelURL("/downloads/{{user}}/{{job}}/" + filename);
         
	stage.loadFile(file, { defaultRepresentation: true }).then( function(comp) {
            comp.setName(name);
	    comp.setSelection("");

            for(var i = 0; i < representations.length; i++) {
	        comp.addRepresentation(representations[i], representation_dicts[i]);
            }

	    if (center) {
	        comp.centerView();
	    }
        });
    }


    function visualize() {
	stage = new NGL.Stage("viewport");
	NGL.StageWidget(stage);
        stage.setParameters( { backgroundColor: "black" } );
 			       
        // Laden der Molekuelstruktur
	var lic_selection = "{{lic_selection}}"
	loadPDB(stage, "protein.pdb", "structure", ["cartoon", "licorice"],  [{colorScheme: 'bfactor'}, {sele: lic_selection}], true);

        // Laden der Hohlraeume
	loadPDB(stage, "onlyHoles.pdb", "holes", ["ball+stick"], [{radius: 'bfactor', colorscheme: 'bfactor'}]);
    }

    /*
    function update_progress(status_url, status_div) {
        // send GET request to status URL
        $.getJSON(status_url, function(data) {
           // update UI
           $(status_div.childNodes[0]).text('Job status:  ' + data['status']);
           if( "Error" ==  data['status'].substring(0,5) ){

               $(status_div.childNodes[2]).addClass("warning").text('JOB SUBMISSION FAILED!' );
               $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );

           } else if( data['status'] == 'finished'){

              if( data['error'] != '0'){
                  $(status_div.childNodes[2]).addClass("warning").text('CALCULATION FAILED!!!' );
                  $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
              } else {
		  visualize();
                  $(status_div.childNodes[2]).text('Click on image to enlarge' );
              }

           } else {
               // rerun in 10 seconds
               setTimeout(function() {
                    update_progress(status_url, status_div);
               }, 10000);
           }
        });
    }
    */

  </script>





{{ super() }}
{% endblock %}


