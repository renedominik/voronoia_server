{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}" media="all">
<link href="https://fonts.googleapis.com/css?family=Questrial&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
{% endblock %}



{% block header %}
  {{super()}}
{% endblock %}



{% block content %}
<section>
    <center>
        <h1>Results</h1>
        <div id="visualisation" class="contentBody">
          <h2>V I E W</h2>
	  <p> {{ tag }} </p>
          <div id="viewport"></div>
	  <br>
	  <h2>S T A T U S</h2>
	  <p><div id="progress"></div></p>
	  <p>Results will be displayed above as soon as calculations are finished. This may take up to ten minutes.</p>
	  <p>If you store the URL you can access your results for the next 4 weeks.</p>
        </div>
    </center>
</section>
{% endblock %}



{% block scripts %}
<script src="{{url_for('static', filename='ngl.js')}}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script> 
    NGL.mainScriptPathFile = "{{url_for('static', filename='ngl.js')}}";

    $().ready( function() {
	console.log("vor dem fehler?")
        div = $('<div class="btn"><div></div><div></div><div></div><div></div></div>');
	$('#progress').append(div);
	status_url = getModelURL('/status/{{user}}/{{job}}');
   	update_progress( status_url, div[0] );
    });

    
    function getModelURL(model) {
   	var href = window.location.href;
  	var command = href.substr(0, href.lastIndexOf("/")) + model;
        return command;
    }


    function loadPDB(stage, filename, name, representation, representation_dict, center) {
	file = getModelURL("/downloads/{{user}}/{{job}}/" + filename);
         
	stage.loadFile(file, { defaultRepresentation: true }).then( function(comp) {
            comp.setName(name);
	    comp.setSelection("");
	    comp.addRepresentation(representation, representation_dict);
	    if (center) {
	        comp.centerView();
	    }
        });
    }


    function visualization() {
	stage = new NGL.Stage("viewport");
        stage.setParameters( { backgroundColor: "black" } );

	var lic_selection = "{{lic_selection}}";

        // Laden der Molekuelstruktur
        loadPDB(stage, "protein.pdb", "structure", "cartoon",  {colorScheme: 'bfactor'}, true);

        // Laden der Hohlraeume
        loadPDB(stage, "onlyHoles.pdb", "holes", "ball+stick", {radius: 'bfactor', colorscheme: 'bfactor'});
    }


    function update_progress(status_url, status_div) {
        // send GET request to status URL
        $.getJSON(status_url, function(data) {
           // update UI
           $(status_div.childNodes[0]).text('Job status:  ' + data['status']);
           if( "Error" ==  data['status'].substring(0,5) ){

               $(status_div.childNodes[2]).addClass("warning").text('JOB SUBMISSION FAILED!' );
               $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );

           } else if( data['status'] == 'finished'){

              if( data['error'] != '0'){
                  $(status_div.childNodes[2]).addClass("warning").text('CALCULATION FAILED!!!' );
                  $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
              } else {
		  visualization();
                  $(status_div.childNodes[2]).text('Click on image to enlarge' );
              }

           } else {
               // rerun in 10 seconds
               setTimeout(function() {
                    update_progress(status_url, status_div);
               }, 10000);
           }
        });
    }

  </script>





{{ super() }}
{% endblock %}


