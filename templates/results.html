{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}" media="all">
<link href="https://fonts.googleapis.com/css?family=Questrial&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
{% endblock %}



{% block header %}
  {{super()}}
{% endblock %}



{% block content %}
<section>
    <center>
        <h1>Results</h1>
        <div id="visualisation" class="contentBody">
          <h2>V I E W</h2>
	  <p> {{ tag }} </p>
          <div id="viewport"></div>
	  <br>
	  <h2>S T A T U S</h2>
	  <p><div id="progress"></div></p>
	  <p>Results will be displayed above as soon as calculations are finished. This may take up to ten minutes.</p>
	  <p>If you store the URL you can access your results for the next 4 weeks.</p>
        </div>
    </center>
</section>
{% endblock %}



{% block scripts %}
<script src="{{url_for('static', filename='ngl.js')}}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script> 
  NGL.mainScriptPathFile = "{{url_for('static', filename='ngl.js')}}";
    
  function getModelURL(model){
                var href = window.location.href;
	  	var command = href.substr(0, href.lastIndexOf("/")) + model;
                console.log("URL: " + command);
                return command;
   }

    

  
   $().ready( function() {
       console.log( "ready");
       div = $('<div class="btn"><div></div><div></div><div></div><div></div></div>');
       $('#progress').append(div);
	   status_url = getModelURL( '{{status_url}}' );
       console.log(status_url);
       update_progress( status_url, div[0] );
   });

   function update_progress(status_url, status_div) {
        console.log("update progress");
        $(status_div.childNodes[2]).text('update every 10s ...');
        
        // send GET request to status URL
        $.getJSON(status_url, function(data) {
           // update UI
           console.log("getJSON");
           $(status_div.childNodes[0]).text('Job status:  ' + data['status']);
           if( "Error" ==  data['status'].substring(0,5) ){
               $(status_div.childNodes[2]).addClass("warning").text('JOB SUBMISSION FAILED!' );
               $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
           }
           else if( data['status'] == 'finished'){
              if( data['error'] != '0'){
                  $(status_div.childNodes[2]).addClass("warning").text('CALCULATION FAILED!!!' );
                  $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
              }
              else{
                   console.log("completed");

	 	  stage = new NGL.Stage("viewport");
  		  console.log(window.location.href);

                  // TODO: move vis stuff to visualize function -> less indentation levels <:

                  var lic_selection;
		   
                  // Laden der PDB-Datei
	 	  file = getModelURL( "/downloads/{{user}}/{{job}}/protein.pdb");
	 	  console.log("file:");
                  console.log(file);
  
	 	  stage.loadFile(file, {defaultRepresentation: true}).then(function(comp) {
	 	          comp.setName("structure");
	 	          comp.setSelection( "" );
	 	          /*comp.addRepresentation( "ball+stick", {radius: "bfactor", colorScheme: "bfactor"} );*/
	 	          comp.addRepresentation( "cartoon", {colorScheme: "bfactor"} );
                          comp.addRepresentation("licorice", {lic_selection});
                          comp.centerView();                                                             
	 	  });
	 
  	 
	 	  stage.setParameters( { backgroundColor: "black" } );

                  // Laden der HohlrÃ¤ume
                  file = getModelURL( "/downloads/{{user}}/{{job}}/onlyHoles.pdb");
		  console.log(file);
		
	          stage.loadFile(file, { defaultRepresentation: true } ).then( function( comp ){
		                comp.setName( "Holes" );
		                comp.setSelection( "" );
		                comp.addRepresentation( "ball+stick", {radius: "bfactor", colorScheme: "bfactor"} );
		  } );

                  $(status_div.childNodes[2]).text('Click on image to enlarge' );
               }
           } 
           else {
               // rerun in 10 seconds
               setTimeout(function() {
                    update_progress(status_url, status_div);
               }, 10000);
           }
        });
    }

  </script>





{{ super() }}
{% endblock %}


