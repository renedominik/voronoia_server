{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}" media="all">
<link href="https://fonts.googleapis.com/css?family=Questrial&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
{% endblock %}



{% block header %}
  {{super()}}
{% endblock %}



{% block content %}
<section>
    <center>
        <h1>Results</h1>
        <div id="visualisation" class="contentBody">
          <h2>V I E W</h2>
	  <p> {{ tag }} </p>
          <div id="viewport"></div>
	  <br>
	  <br>
	  <h4> Status report:</h4><br>
	  <p><div id="progress"></div></p>
	  <p>Results will be displayed above as soon as calculations are finished.</p>
	  <p>This may take up to ten minutes.</p>
	  <p>If you store the URL you can access your results for the next 2 weeks.</p>
        </div>
    </center>
</section>
{% endblock %}



{% block scripts %}
<script src="{{url_for('static', filename='ngl.js')}}"></script>
<script> 
  NGL.mainScriptPathFile = "{{url_for('static', filename='ngl.js')}}";
    
  function getModelURL( model ){
                var href = window.location.href;
                var command = href.substr( 0, href.lastIndexOf( "/" ) + 1 ) + "../../" + model;
                console.log("URL: " + command);
                return command;
              }

  document.addEventListener( "DOMContentLoaded", function(){
  stage = new NGL.Stage("viewport");
  console.log(window.location.href);
      file = getModelURL( "/downloads/{{user}}/{{job}}/protein.pdb");
      console.log("file:");
      console.log(file);
      stage.loadFile(file, {defaultRepresentation: true}).then(function(comp) {
          comp.setName("structure");
          comp.setSelection( "" );
          /*comp.addRepresentation( "ball+stick", {radius: "bfactor", colorScheme: "bfactor"} );*/
          comp.addRepresentation( "cartoon" );
          comp.centerView();                                                             
      });
      stage.setParameters( { backgroundColor: "black" } );
  } );
    
</script>



  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script>
    
    $().ready( function() {
       console.log( "ready");
       div = $('<div class="btn"><div></div><div></div><div></div><div></div></div>');
       $('#progress').append(div);
    status_url = getModelURL( '{{status_url}}' );
    console.log(status_url);
       update_progress( status_url, div[0] );
    });

    function update_progress(status_url, status_div) {
        console.log("update progress");
        $(status_div.childNodes[2]).text('update every 10s ...');
        
        // send GET request to status URL
        $.getJSON(status_url, function(data) {
           // update UI
           console.log("getJSON");
           $(status_div.childNodes[0]).text('Job status:  ' + data['status']);
           if( "Error" ==  data['status'].substring(0,5) ){
               $(status_div.childNodes[2]).addClass("warning").text('JOB SUBMISSION FAILED!' );
               $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
           }
           else if( data['status'] == 'finished'){
              if( data['error'] != '0'){
                  $(status_div.childNodes[2]).addClass("warning").text('CALCULATION FAILED!!!' );
                  $(status_div.childNodes[3]).text('try again and if problems still persists drop us an email.' );
              }
              else{
      //console.log("completed");

      // ADD NGL SPHERES AND STUFF HERE !! 
                  $(status_div.childNodes[2]).text('JOB IS COMPLETED' );
               }
           } 
           else {
               // rerun in 10 seconds
               setTimeout(function() {
                  update_progress(status_url, status_div);
               }, 10000);
           }
        });
    }

  </script>





{{ super() }}
{% endblock %}


