from flask import Flask, render_template, session, url_for, redirect, request
from flask_bootstrap import Bootstrap
from flask_wtf import FlaskForm
from wtforms import  StringField, SubmitField, SelectField, FileField
from wtforms.validators import Email, DataRequired
from werkzeug import secure_filename

from datetime import datetime
import random, string, os


app = Flask(__name__)
app.config['SECRET_KEY'] = 'Lhvz7/{{4$34"_.b'


bootsrap = Bootstrap(app)


class InputForm(FlaskForm):
    #Definieren der Eingabefelder
    pdb = FileField('Upload a pdb file')#, validators=[FileRequired()])
    email = StringField('Enter your email adress (optional):', validators=[Email()])
    tag = StringField('Tag your job:', validators=[DataRequired()])
    options = SelectField('Select the database containing atom radii', choices=[('1', 'protor'), ('2', 'the other one')])    
    submit = SubmitField('Submit')


#def validatePdb(filename):
#    return '.' in filename and (filename.rsplit('.', 1)[1] == 'pdb')


@app.route('/', methods=['GET', 'POST'])
def index():
    print('index')
    form = InputForm()
    if form.validate_on_submit():

        #Einlesen der PDB-Datei
        f = request.files['pdb']

        #Festlegen vom Pfad
        #output_dir = '/disk/user_data/v4rna/sessions/'
        output_dir = '/'
        if form.email.data != '':
            output_dir += form.email.data + '/'
            os.mkdir(output_dir)
        else:
            output_dir += 'anonymous/'

        #Zusammenf√ºgen des Directorynamens
        now = datetime.now()
        date = now.strftime("%Y%m%d%H%M")
        random_id = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(6))
        id_str = date + '_' + random_id
        output_dir += id_str
        print( output_dir)
        os.mkdir( output_dir)
        
        #Speichern der Datei 
        #filename = output_dir + secure_filename(f.filename)
        filename = secure_filename(f.filename)
        f.save(filename) 
        return redirect('/home') # uebergabe pfad an ausgabe seite 
    return render_template('formular.html', form=form)

@app.route('/results')
def results():
    print('calculations finished')
    return render_template('results.html')

@app.route('/methods')
def methods():
    return '<h1>METHODS</h1>'

@app.route('/references')
def references():
    return '<h1>REFERENCES</h1>'
